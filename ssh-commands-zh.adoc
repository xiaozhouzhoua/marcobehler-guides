= 13ä¸ªå¿…å­¦SSHå‘½ä»¤âœ¨
Marco Behler
2022-10-28
:page-layout: layout-guides
:page-image: "/images/guides/undraw_security_re_a2rk.png"
:page-description: æˆ‘æ—¥å¸¸ä½¿ç”¨çš„SSHè¿æ¥ã€å¯†é’¥ç”Ÿæˆå’ŒSSHä»£ç†çš„çƒ­é—¨å‘½ä»¤æ¸…å•ğŸ’»
:page-published: true
:page-tags: ["ssh", "ssh agent", "ssh keygen", "ssh keys"]
:page-commento_id: ssh-cheat-sheet

== SSHå¯†é’¥ç”ŸæˆğŸ”‘

ç°åœ¨å¤§éƒ¨åˆ†å¹³å°éƒ½æ¨èä½¿ç”¨ed25519ç®—æ³•ç”Ÿæˆå¯†é’¥å“¦ï½

[source,console]
----
ssh-keygen -t ed25519 -C "your@email.com"
----

å¦‚æœä¸ºäº†å…¼å®¹æ€§æƒ³ç”¨RSAï¼Œå¯ä»¥è¿™æ ·ï¼š

[source,console]
----
ssh-keygen -t rsa -b 4096 -C "your@email.com"
----

`_-C_` å‚æ•°ä¼šåœ¨ä½ çš„å…¬é’¥ä¸Šæ·»åŠ æ³¨é‡Šï¼Œè¿™æ ·åœ¨ç¹å¿™çš„ <<authorized_keys>> æ–‡ä»¶ä¸­å°±èƒ½è½»æ¾åˆ†è¾¨å“ªä¸ªå…¬é’¥å±äºå“ªä¸ªé‚®ç®±åœ°å€å•¦ğŸ’¡

[source,text]
----
ssh-ed25519 KLAJSDLKSAJKLSJD90182980p1+++ your@email.com
----

*é‡è¦æé†’*ï¼šç”ŸæˆSSHå¯†é’¥æ—¶ï¼Œä¸€å®šè¦ç”¨å¯†ç çŸ­è¯­ä¿æŠ¤ä½ çš„ç§é’¥ï¼ğŸ”’

== ä½¿ç”¨å¯†é’¥è¿›è¡ŒSSHè¿æ¥

æƒ³ç”¨ç‰¹å®šçš„ç§é’¥è¿æ¥æœåŠ¡å™¨ï¼Ÿè¯•è¯•è¿™ä¸ªï¼š

[source,console]
----
ssh -i mykeyfile user@remotehost.com
----

ä¸è¿‡ä¸å…¶æ‰‹åŠ¨ç”¨ `_-i_` æŒ‡å®šå¯†é’¥æ–‡ä»¶ï¼Œä¸å¦‚ä½¿ç”¨ <<ssh-agent>> æ›´æ–¹ä¾¿ï½

[[authorized_keys]]
== æˆæƒå¯†é’¥æ–‡ä»¶ğŸ“‹

ä»»ä½•ä½ æƒ³ä½¿ç”¨SSHå¯†é’¥è¿æ¥çš„è¿œç¨‹ä¸»æœºæˆ–æœåŠ¡ï¼ˆæ¯”å¦‚GitHubï¼‰ï¼Œéƒ½éœ€è¦ä½ çš„SSHå¯†é’¥å¯¹ä¸­çš„ `_å…¬é’¥_`ã€‚

å¯¹äºæœåŠ¡å™¨ï¼Œåªéœ€è¦æŠŠä½ çš„å…¬é’¥æ·»åŠ åˆ° `_~/.ssh/authorized_keys_` æ–‡ä»¶ä¸­ï¼š

ç”¨ä»¥ä¸‹å‘½ä»¤ä¹‹ä¸€æ¥æ“ä½œï¼š

* `_cat ~/.ssh/id_rsa.pub | ssh USER@HOST "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"_` - https://askubuntu.com/a/262074
* `_ssh-copy-id user@host_` - https://askubuntu.com/a/46427

å¯¹äºGitHubã€AWSç­‰æœåŠ¡ï¼Œä½ å¯ä»¥é€šè¿‡UIç•Œé¢ä¸Šä¼ å…¬é’¥ï¼Œæˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚

== æ–‡ä»¶ä¼ è¾“ç¥å™¨SCPğŸ“

ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š

[source,console]
----
scp myfile.txt user@dest:/path
----

é€’å½’ä¸Šä¼ æœ¬åœ°æ–‡ä»¶å¤¹ï¼š

[source,console]
----
scp -rp sourcedirectory user@dest:/path
----

ä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½æ–‡ä»¶ï¼š

[source,console]
----
scp user@dest:/path/myfile.txt localpath
----

é€’å½’ä¸‹è½½è¿œç¨‹æ–‡ä»¶å¤¹åˆ°æœ¬åœ°ï¼š

[source,console]
----
scp -rp user@dest:/remotedir localpath
----

*å°è´´å£«*ï¼šé€’å½’ä¼ è¾“æ—¶ï¼Œè€ƒè™‘ä½¿ç”¨rsyncï¼Œå®ƒä¹Ÿèµ°SSHåè®®ï¼Œæ¯”SCPæœ‰ https://serverfault.com/a/264606[æ›´å¤šä¼˜åŠ¿] å“¦ï¼âœ¨

[line-through]#*å°è´´å£«2*ï¼šhttps://lwn.net/Articles/835962/[SCPå·²è¢«å¼ƒç”¨]ï¼Œä½ åº”è¯¥è€ƒè™‘åˆ‡æ¢åˆ°ï¼ˆä¸å¤ªç”¨æˆ·å‹å¥½çš„ï¼‰SFTPã€‚# https://news.ycombinator.com/item?id=32026913[è‡ªOpenSSH 9èµ·ï¼Œscpå‘½ä»¤ä½¿ç”¨SFTPåè®®]ã€‚

[[ssh-agent]]
== SSHä»£ç†ç®¡å®¶ğŸ¤–

å¤§éƒ¨åˆ†Linuxå‘è¡Œç‰ˆå’ŒmacOSéƒ½è‡ªå¸¦OpenSSHä»£ç†ï¼Œç›´æ¥ç”¨ï¼š

[source,console]
----
ssh-add privatekeyfile
----

Windowsç”¨æˆ·éœ€è¦å…ˆå¯ç”¨OpenSSHä»£ç†æœåŠ¡ï¼Œæ‰§è¡Œä»¥ä¸‹ https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_keymanagement[å‘½ä»¤]ï¼š

[source,console]
----
# é»˜è®¤ssh-agentæœåŠ¡æ˜¯ç¦ç”¨çš„ï¼Œå…ˆå…è®¸æ‰‹åŠ¨å¯åŠ¨
# ç¡®ä¿ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
Get-Service ssh-agent | Set-Service -StartupType Automatic

# å¯åŠ¨æœåŠ¡
Start-Service ssh-agent
----

*å°æé†’*ï¼šåœ¨Windows/Linuxä¸Šï¼Œä¸€æ—¦æ·»åŠ å¯†é’¥åˆ°ssh-agentï¼ˆå³ä½¿æœ‰å¯†ç ï¼‰ï¼Œé‡å¯ç”µè„‘ç™»å½•åèº«ä»½éªŒè¯ä¼šè‡ªåŠ¨å¯ç”¨ã€‚

macOSéœ€è¦æŒ‰ç…§è¿™äº› https://apple.stackexchange.com/a/250572[StackExchangeæŒ‡ç¤º] æ‰èƒ½å®ç°ç›¸åŒæ•ˆæœã€‚

== SSHé…ç½®æ–‡ä»¶âš™ï¸

åˆ›å»º `_~/.ssh/config_` æ–‡ä»¶æ¥ç®¡ç†SSHä¸»æœºè¿æ¥ï¼š

[source,text]
----
Host dev-meta*
    User ec2-user
    IdentityFile ~/.ssh/johnsnow.pem

Host dev-meta-facebook
    Hostname 192.168.178.1

Host dev-meta-whatsapp
    Hostname 192.168.178.2

Host api.google.com
    User googleUser
    IdentityFile ~/.ssh/targaryen.key
----

*æ³¨æ„*ï¼š

`_Host_` æŒ‡ä»¤å¯ä»¥ï¼š

* æ˜¯ä¸€ä¸ªæ¨¡å¼ï¼ˆåŒ¹é…å¤šä¸ªåç»­ `_Hosts_`ï¼‰
* å¼•ç”¨ä¸€ä¸ªè™šæ„çš„ä¸»æœºåï¼ˆ`_dev-facebook_`ï¼‰
* æ˜¯ä¸€ä¸ªçœŸå®çš„ä¸»æœºå

å¦‚æœæ˜¯è™šæ„ä¸»æœºåï¼Œéœ€è¦æŒ‡å®šé¢å¤–çš„ `_Hostname_` æŒ‡ä»¤ï¼Œå¦åˆ™å¯ä»¥çœç•¥ã€‚æ›´ä»¤äººå›°æƒ‘çš„æ˜¯ï¼Œ`_Host_` è¡Œå®é™…ä¸Šå¯ä»¥åŒ…å«å¤šä¸ªæ¨¡å¼ã€‚

æœ‰äº†ä¸Šé¢çš„é…ç½®ï¼Œä½ å°±å¯ä»¥ç®€å•æ‰§è¡Œï¼š

[source,console]
----
ssh dev-meta-facebook
----

è¿™ç­‰åŒäºæ‰§è¡Œ `_ssh -i ~/.ssh/johnsnow.pem ec2-user@192.168.178.1_`ï¼Œæ˜¯ä¸æ˜¯è¶…æ–¹ä¾¿ï¼ğŸ‰

æŸ¥çœ‹æ‰€æœ‰å¯ç”¨é€‰é¡¹çš„å®Œæ•´æ¦‚è¿°ï¼Œè¯·çœ‹ https://linuxize.com/post/using-the-ssh-config-file/[è¿™ç¯‡æ–‡ç« ]ã€‚

== Git & Windows OpenSSH

è®©Gitä½¿ç”¨Windowsçš„OpenSSHï¼ˆè€Œä¸æ˜¯è‡ªå¸¦çš„ï¼‰ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

[source,console]
----
git config --global core.sshcommand "C:/Windows/System32/OpenSSH/ssh.exe"
----

== é€€å‡ºå¡æ­»çš„SSHä¼šè¯

è¦æ€æ­»æ— å“åº”çš„SSHä¼šè¯ï¼Œä¾æ¬¡æŒ‰ï¼š

[source,console]
----
Enter, ~, .
----

== å¤šä¸ªGitHubå¯†é’¥å¯¹ğŸ”‘

å°è¯•å…‹éš†ä¸åŒçš„ç§æœ‰GitHubä»“åº“ï¼ˆå®ƒä»¬æœ‰ä¸åŒçš„SSHå¯†é’¥å¯¹å…³è”ï¼‰é»˜è®¤æ˜¯ä¸è¡Œçš„ã€‚

å°†æ­¤æ·»åŠ åˆ°ä½ çš„ `_.ssh/config_`ï¼ˆè¿™ä¸ªä¾‹å­å‡è®¾ä½ æœ‰ä¸¤ä¸ªGitHubå¯†é’¥å¯¹ï¼Œä¸€ä¸ªç”¨äºå·¥ä½œè´¦æˆ·ï¼Œä¸€ä¸ªç”¨äºä¸ªäººè´¦æˆ·ï¼‰ï¼š

[source,console]
----
Host github-work.com
    Hostname github.com
    IdentityFile ~/.ssh/id_work

Host github-personal.com
    Hostname github.com
    IdentityFile ~/.ssh/id_personal
----

ç„¶åä¸è¦ä» `_github.com_` å…‹éš†ï¼š

[source,console]
----
git clone git@github.com:marcobehlerjetbrains/buildpipelines.git
----

è€Œæ˜¯ä» `_github-work.com_` æˆ– `_github-personal.com_` å…‹éš†ï¼š

[source,console]
----
git clone git@github-work.com:marcobehlerjetbrains/buildpipelines.git
----

== SSHä»£ç†è½¬å‘

æƒ³åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šä½¿ç”¨ä½ çš„æœ¬åœ°SSHå¯†é’¥ï¼Œä½†ä¸æƒ³å¤åˆ¶å¯†é’¥åˆ°é‚£å°æœåŠ¡å™¨ï¼Ÿæ¯”å¦‚åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šé€šè¿‡SSH `_git clone_` ç§æœ‰ä»“åº“ï¼Ÿ

ä»£ç†è½¬å‘æ¥æ•‘åœºï¼ç¼–è¾‘ä½ çš„æœ¬åœ° `_.ssh/config_` æ–‡ä»¶ï¼š

[source,console]
----
Host yourremoteserver.com
    ForwardAgent yes
----

ç„¶åç®€å•åœ° `_ssh_` åˆ°ä½ çš„æœåŠ¡å™¨å¹¶æ‰§è¡Œ `_ssh-add -L`ã€‚æœåŠ¡å™¨çš„SSHä»£ç†åº”è¯¥ä¼šæœ‰æ‰€æœ‰æœ¬åœ°SSHèº«ä»½å¯ç”¨ï¼Œä½ å°±å¯ä»¥å¼€å§‹å…‹éš†äº†ï¼

== SSHä»£ç†è½¬å‘ï¼šWindowsåˆ°WSL

å¦‚æœä½ æƒ³åœ¨WSLä¸­ä½¿ç”¨Windows OpenSSHä»£ç†åŠå…¶æ‰€æœ‰èº«ä»½ï¼Œè¿™æ ·åšï¼š

1. å®‰è£… `_socat_`ï¼Œæ¯”å¦‚åœ¨ä½ çš„WSLå‘è¡Œç‰ˆä¸Šï¼šUbuntu/Debianç”¨ `_apt install socat_`ã€‚
2. ä¸‹è½½ https://github.com/jstarks/npiperelay/releases/tag/v0.1.0[npiperelay] æ„å»ºç‰ˆæœ¬å¹¶æ”¾åˆ°ä½ çš„ï¼ˆWindowsï¼‰PATHä¸­ã€‚
3. å°†ä»¥ä¸‹å†…å®¹æ”¾å…¥ä½ çš„WSL `_~/.bash_profile_` æˆ– `_~/.bashrc_`ï¼š

[source,bash]
----
# é…ç½®sshè½¬å‘
export SSH_AUTH_SOCK=$HOME/.ssh/agent.sock
# éœ€è¦ `ps -ww` è·å–å®Œæ•´å‘½ä»¤è¿›è¡ŒåŒ¹é…
# ä½¿ç”¨æ–¹æ‹¬å·ç”Ÿæˆæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æˆ‘ä»¬æƒ³è¦çš„è¿›ç¨‹ï¼Œä½†ä¸åŒ¹é…è¿è¡Œå®ƒçš„grepå‘½ä»¤ï¼
ALREADY_RUNNING=$(ps -auxww | grep -q "[n]piperelay.exe -ei -s //./pipe/openssh-ssh-agent"; echo $?)
if [[ $ALREADY_RUNNING != "0" ]]; then
    if [[ -S $SSH_AUTH_SOCK ]]; then
        # ä¸æœŸæœ›socketå­˜åœ¨ï¼Œå› ä¸ºè½¬å‘å‘½ä»¤æ²¡åœ¨è¿è¡Œ (http://www.tldp.org/LDP/abs/html/fto.html)
        echo "ç§»é™¤ä¹‹å‰çš„socket..."
        rm $SSH_AUTH_SOCK
    fi
    echo "å¯åŠ¨SSH-Agentä¸­ç»§..."
    # setsidå¼ºåˆ¶æ–°ä¼šè¯ä¿æŒè¿è¡Œ
    # è®¾ç½®socatç›‘å¬$SSH_AUTH_SOCKå¹¶è½¬å‘åˆ°npiperelayï¼Œç„¶åè½¬å‘åˆ°windowsä¸Šçš„openssh-ssh-agent
    (setsid socat UNIX-LISTEN:$SSH_AUTH_SOCK,fork EXEC:"npiperelay.exe -ei -s //./pipe/openssh-ssh-agent",nofork &) >/dev/null 2>&1
fi
----

å¥½ç”¨ï¼

ç‰¹åˆ«æ„Ÿè°¢Stuart Leeksï¼Œæˆ‘åšé¢œæ— è€»åœ°å·äº†ä»–çš„ä»£ç  - ä»–åœ¨ https://stuartleeks.com/posts/wsl-ssh-key-forward-to-windows/ åšäº†æ‰€æœ‰å·¥ä½œã€‚

æŸ¥çœ‹ä»–çš„ https://wsl.tips/book[WSLä¹¦ç±] äº†è§£æ›´å¤šè¿™æ ·çš„æŠ€å·§ï¼

== SSHéš§é“ğŸš‡

æƒ³è¿æ¥åˆ°ä¸€ä¸ªå¯¹å¤–ç•Œéšè—ä½†å¯ä»¥ä»ä½ æœ‰SSHè®¿é—®æƒé™çš„æœºå™¨è®¿é—®çš„æœåŠ¡å™¨ï¼Ÿæ¯”å¦‚Amazon RDSæ•°æ®åº“ï¼Œåªèƒ½ä»AWSç½‘ç»œå†…éƒ¨è®¿é—®ï¼Ÿ

ä½¿ç”¨SSHè½¬å‘ï¼š

[source,console]
----
ssh username@jumphost -N -f -L localport:targethost:targetport
----

ä»¥ä¸‹å‘½ä»¤åœ¨æˆ‘çš„ `_æœ¬åœ°æœºå™¨ï¼ˆ@ç«¯å£3307ï¼‰_` å’Œ `_RDSæ•°æ®åº“ï¼ˆ@ç«¯å£3306ï¼‰_` ä¹‹é—´å»ºç«‹SSHéš§é“ï¼Œé€šè¿‡ `_EC2è·³æ¿æœºï¼ˆ18.11.11.11ï¼‰_`ï¼š

[source,console]
----
ssh ec2-user@18.11.11.11 -N -f -L 3307:marcotestme.12345.eu-central-1.rds.amazonaws.com:3306
----

ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨mysqlå®¢æˆ·ç«¯è¿æ¥åˆ° `_localhost:3307_`ï¼Œå®ƒä¼šé€æ˜åœ°éš§é“åˆ°RDSï¼š

[source,console]
----
mysql -h localhost -P 3307
----

*æ³¨æ„*ï¼šå¾ˆå¤šå·¥å…·/IDEå¦‚ https://www.jetbrains.com/idea/[IntelliJ IDEA]ï¼Œæ”¯æŒåœ¨UIä¸­å‹¾é€‰å¤é€‰æ¡†å°±èƒ½æ‰“å¼€SSHéš§é“ã€‚

== å¯†ç ç®¡ç†å™¨ä¸SSHä»£ç†

åƒ https://developer.1password.com/docs/ssh/agent/[1Password] æˆ– https://lechnology.com/software/keeagent/[Keepass] è¿™æ ·çš„å¯†ç ç®¡ç†å™¨ä¸ä»…å¯ä»¥å­˜å‚¨ä½ çš„SSHå¯†é’¥ï¼Œè¿˜è‡ªå¸¦ `_ssh-agent_`ï¼Œæ›¿æ¢ç³»ç»Ÿçš„ssh-agentã€‚

è¿™æ„å‘³ç€ï¼Œå½“ä½ åœ¨ä»»ä½•å®‰è£…äº†å¯†ç ç®¡ç†å™¨çš„æœºå™¨ä¸Šè§£é”å®ƒæ—¶ï¼Œä½ çš„æ‰€æœ‰SSHèº«ä»½éƒ½ä¼šç«‹å³å¯ç”¨ã€‚

è¶…å®ç”¨ï¼ğŸ’¯

== è§†é¢‘æ•™ç¨‹ğŸ“º

å¦‚æœä½ æ›´å–œæ¬¢è§†é¢‘å½¢å¼å­¦ä¹ æŸäº›ä¸»é¢˜ï¼Œå¯ä»¥åœ¨YouTubeä¸Šè§‚çœ‹å®æˆ˜æŒ‡å—ã€‚

mb_youtube::UnM4QAumuCQ[]